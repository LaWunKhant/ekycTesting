<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoonKYC - Document Verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #999;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .step.active {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .step.completed {
            background: #4CAF50;
            color: white;
        }

        .camera-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        .camera-container.active {
            display: block;
        }

        #video{
          width:100%;
          height:100%;
          display:block;
          object-fit:cover;
          background:#000;
          transform: scaleX(1); /* Default: no mirror */
        }

        /* Mirror the live preview ONLY for selfie */
        #video.mirror {
          transform: scaleX(-1);
        }

        #displayCanvas {
            width: 100%;
            display: block;
        }

        #canvas {
            display: none;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .guide-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px dashed rgba(255, 255, 255, 0.6);
            border-radius: 15px;
        }

        .guide-box.selfie {
            width: 60%;
            height: 70%;
            border-radius: 50%;
        }

        .camera-instructions {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 10;
        }

        .capture-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 5px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            pointer-events: auto;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .capture-btn:hover {
            transform: translateX(-50%) scale(1.1);
            background: #f0f0f0;
        }

        .capture-btn:active {
            transform: translateX(-50%) scale(0.95);
            background: #e0e0e0;
        }

        .preview-container {
            display: none;
            text-align: center;
        }

        .preview-container.active {
            display: block;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .start-screen {
            text-align: center;
        }

        .start-screen.hidden {
            display: none;
        }

        .document-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .start-screen h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .start-screen p {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .requirements {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .requirements h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .requirements ul {
            list-style: none;
            padding-left: 0;
        }

        .requirements li {
            padding: 8px 0;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .requirements li::before {
            content: '‚úì';
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
        }

        .liveness-screen {
            text-align: center;
            display: none;
        }

        .liveness-screen.active {
            display: block;
        }

        .liveness-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .liveness-instructions {
            background: #f0f7ff;
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .liveness-instructions h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .liveness-instructions ol {
            margin-left: 20px;
            color: #333;
            line-height: 1.8;
        }

        .liveness-instructions li {
            margin-bottom: 8px;
        }

        .liveness-note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 14px;
            color: #856404;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .status-message.active {
            display: block;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .verification-result {
            text-align: center;
            padding: 30px;
            display: none;
        }

        .verification-result.active {
            display: block;
        }

        .result-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .result-icon.success {
            color: #4CAF50;
        }

        .result-icon.failed {
            color: #f44336;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }

            .header h1 {
                font-size: 24px;
            }

            .step {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåô MoonEKYC</h1>
            <p>Secure Identity Verification System</p>
        </div>

        <div class="content">
            <div class="step-indicator">
                <div class="step" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">3</div>
                <div class="step" id="step4">4</div>
                <div class="step" id="step5">5</div>
            </div>

            <div class="start-screen" id="startScreen">
                <div class="document-icon">üìÑ</div>
                <h2>Welcome to Identity Verification</h2>
                <p>We'll guide you through a secure verification process</p>

                <div class="requirements">
                    <h3>You'll need:</h3>
                    <ul>
                        <li>Your ID card (front and back)</li>
                        <li>Good lighting</li>
                        <li>Camera permission</li>
                        <li>3-4 minutes of your time</li>
                    </ul>
                </div>

                <button class="btn btn-primary" onclick="startVerification()">Start Verification</button>
            </div>

            <div class="camera-container" id="cameraContainer">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display:none;"></canvas>
                <div class="camera-overlay">
                    <div class="guide-box" id="guideBox"></div>
                    <div class="camera-instructions" id="instructions">Position your ID within the frame</div>
                </div>
                <button class="capture-btn" id="captureBtn">üì∑</button>
            </div>

            <div class="preview-container" id="previewContainer">
                <img id="previewImage" class="preview-image" alt="Captured image">
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="retakePhoto()">üîÑ Retake</button>
                    <button class="btn btn-primary" onclick="confirmPhoto()">‚úì Use This Photo</button>
                </div>
            </div>

            <div class="liveness-screen" id="livenessScreen">
                <div class="liveness-icon">üé≠</div>
                <h2>Liveness Detection</h2>
                <p>Let's verify you're a real person</p>

                <div class="liveness-instructions">
                    <h3>üìã What you'll do:</h3>
                    <ol>
                        <li>Look at the center of your screen</li>
                        <li>Turn your head <strong>LEFT</strong></li>
                        <li>Turn your head <strong>RIGHT</strong></li>
                        <li>Open your mouth <strong>2 times</strong> naturally</li>
                    </ol>

                    <div class="liveness-note">
                        <strong>‚ö° Note:</strong> This will open a separate window for liveness detection.
                        Please complete the challenges and return here when done. Press 'Q' to quit if needed.
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="skipLiveness()">Skip (Not Recommended)</button>
                    <button class="btn btn-primary" onclick="startLivenessDetection()">üöÄ Start Liveness Check</button>
                </div>
            </div>

            <div class="verification-result" id="verificationResult">
                <div class="result-icon" id="resultIcon">‚úÖ</div>
                <h2 id="resultTitle">Verification Complete!</h2>
                <p id="resultMessage">Your identity has been successfully verified.</p>
                <div id="resultDetails"></div>
                <button class="btn btn-primary" onclick="startOver()" style="margin-top: 20px;">Start New Verification</button>
            </div>

            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let stream = null;
        let animationFrameId = null;
        let actualFacingMode = null;
        let capturedImages = {
            front: null,
            back: null,
            selfie: null
        };
        let capturedPaths = {
            front: null,
            back: null,
            selfie: null
        };
        let livenessCompleted = false;
        let livenessCheckInterval = null;

        const steps = [
            { id: 'front', title: 'ID Card Front', icon: 'üìÑ', instruction: 'Position the FRONT of your ID card within the frame' },
            { id: 'back', title: 'ID Card Back', icon: 'üìÑ', instruction: 'Position the BACK of your ID card within the frame' },
            { id: 'liveness', title: 'Liveness Check', icon: 'üé≠', instruction: 'Verifying you are a real person...' },
            { id: 'selfie', title: 'Selfie Photo', icon: 'ü§≥', instruction: 'Position your face within the frame' },
            { id: 'verify', title: 'Verification', icon: '‚úì', instruction: 'Verifying your identity...' }
        ];

        function startVerification() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('cameraContainer').classList.add('active');
            updateStepIndicator(0);
            startCamera();
        }

        async function startCamera() {
              try {
                const stepId = steps[currentStep].id;
                const video = document.getElementById('video');

                if (stream) stream.getTracks().forEach(t => t.stop());
                if (animationFrameId) cancelAnimationFrame(animationFrameId);

                const constraints = {
                  video: {
                    facingMode: stepId === 'selfie' ? 'user' : { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                  }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                // Mirror the preview ONLY for selfie (front camera)
                if (stepId === 'selfie' || stepId === 'front' || stepId === 'back') {
                    video.classList.add('mirror');
                } else {
                    video.classList.remove('mirror');
                }

                await new Promise(resolve => {
                  video.onloadedmetadata = () => {
                    video.play();
                    resolve();
                  };
                });

                updateInstructions();
                setupCaptureButton();

              } catch (error) {
                console.error('Camera error:', error);
                showStatus('error', `${error.name}: ${error.message}`);
              }
        }

        function setupCaptureButton() {
            const captureBtn = document.getElementById('captureBtn');
            captureBtn.onclick = capturePhoto;
        }

        function updateInstructions() {
            const step = steps[currentStep];
            document.getElementById('instructions').textContent = step.instruction;

            const guideBox = document.getElementById('guideBox');
            if (step.id === 'selfie') {
                guideBox.classList.add('selfie');
            } else {
                guideBox.classList.remove('selfie');
            }
        }

        function updateStepIndicator(step) {
            for (let i = 0; i < 5; i++) {
                const stepEl = document.getElementById(`step${i + 1}`);
                stepEl.classList.remove('active', 'completed');
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const stepId = steps[currentStep].id;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // DON'T mirror the captured image - we want text to be readable
            // The preview is mirrored for UX, but the saved photo should NOT be mirrored
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = canvas.toDataURL('image/jpeg', 0.95);
            capturedImages[stepId] = imageData;

            document.getElementById('cameraContainer').classList.remove('active');
            document.getElementById('previewContainer').classList.add('active');
            document.getElementById('previewImage').src = imageData;
        }

        function retakePhoto() {
            document.getElementById('previewContainer').classList.remove('active');
            document.getElementById('cameraContainer').classList.add('active');
        }

        async function confirmPhoto() {
            const stepId = steps[currentStep].id;
            const imageData = capturedImages[stepId];

            showStatus('loading', 'Uploading and checking image quality...');

            try {
                const response = await fetch('/capture/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData,
                        type: stepId
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    showStatus('error', data.error);
                    setTimeout(() => {
                        retakePhoto();
                    }, 2000);
                    return;
                }

                capturedPaths[stepId] = data.filename;
                showStatus('success', `${steps[currentStep].title} captured successfully!`);

                setTimeout(() => {
                    hideStatus();
                    document.getElementById('previewContainer').classList.remove('active');

                    currentStep++;

                    if (currentStep === 2) {
                        stopCamera();
                        updateStepIndicator(2);
                        document.getElementById('livenessScreen').classList.add('active');
                    } else if (currentStep < 4) {
                        updateStepIndicator(currentStep);
                        document.getElementById('cameraContainer').classList.add('active');
                        startCamera();
                    } else {
                        stopCamera();
                        verifyIdentity();
                    }
                }, 1500);

            } catch (error) {
                showStatus('error', 'Upload failed: ' + error.message);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        async function startLivenessDetection() {
          const w = window.open(
            "/liveness.html",
            "livenessWindow",
            "width=520,height=820"
          );

          if (!w) {
            showStatus('error', "Popup blocked. Allow popups for this site (localhost) and try again.");
            return;
          }

          showStatus('loading', 'Starting liveness detection...');

          try {
            await fetch('/start-liveness/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
          } catch (error) {
            console.log("start-liveness failed:", error);
          }

          window.addEventListener("message", async (event) => {
            if (!event.data || event.data.type !== "liveness_result") return;

            const result = event.data.data;

            if (result.verified) {
              livenessCompleted = true;
              showStatus('success', `‚úì Liveness verified! Confidence: ${result.confidence}%`);
              setTimeout(() => proceedAfterLiveness(), 1500);
            } else {
              showStatus('error', 'Liveness verification failed. Please try again.');
              setTimeout(() => hideStatus(), 3000);
            }

            try {
              await fetch('/liveness-result/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(result)
              });
            } catch (e) {
              console.log('Backend result send failed:', e);
            }
          }, { once: true });
        }

        function skipLiveness() {
            if (confirm('Skipping liveness detection may reduce security. Continue anyway?')) {
                showStatus('warning', 'Liveness check skipped. Proceeding with selfie capture...');
                setTimeout(() => {
                    proceedAfterLiveness();
                }, 1500);
            }
        }

        async function proceedAfterLiveness() {
            hideStatus();
            document.getElementById('livenessScreen').classList.remove('active');
            currentStep = 3;
            updateStepIndicator(currentStep);
            await startCamera();
            document.getElementById('cameraContainer').classList.add('active');
        }

        async function verifyIdentity() {
            updateStepIndicator(4);
            showStatus('loading', 'Verifying your identity... This may take a moment.');

            try {
                const response = await fetch('/verify/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        front_image: capturedPaths.front,
                        back_image: capturedPaths.back,
                        selfie_image: capturedPaths.selfie,
                        liveness_verified: livenessCompleted
                    })
                });

                const data = await response.json();

                hideStatus();
                showResult(data);

            } catch (error) {
                hideStatus();
                showStatus('error', 'Verification failed: ' + error.message);
            }
        }

        function showResult(data) {
            const resultContainer = document.getElementById('verificationResult');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            const resultDetails = document.getElementById('resultDetails');

            if (data.success && data.verified) {
                resultIcon.textContent = '‚úÖ';
                resultIcon.className = 'result-icon success';
                resultTitle.textContent = 'Verification Successful!';
                resultMessage.textContent = `Identity confirmed with ${data.confidence.toFixed(1)}% confidence.`;
                resultDetails.innerHTML = `
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: left;">
                        <strong>Verification Details:</strong><br>
                        Similarity Score: ${data.similarity.toFixed(1)}%<br>
                        Liveness: ${livenessCompleted ? '‚úì Verified' : '‚ö† Skipped'}<br>
                        Status: Verified ‚úì
                    </div>
                `;
            } else {
                resultIcon.textContent = '‚ùå';
                resultIcon.className = 'result-icon failed';
                resultTitle.textContent = 'Verification Failed';
                resultMessage.textContent = data.error || 'Identity could not be verified. Please try again.';
                resultDetails.innerHTML = '';
            }

            resultContainer.classList.add('active');
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message active ${type}`;
            statusEl.innerHTML = type === 'loading' ?
                `<div class="spinner"></div>${message}` :
                message;
        }

        function hideStatus() {
            document.getElementById('statusMessage').classList.remove('active');
        }

        function startOver() {
            location.reload();
        }

        window.addEventListener('beforeunload', () => {
            stopCamera();
            if (livenessCheckInterval) {
                clearInterval(livenessCheckInterval);
            }
        });
    </script>
</body>
</html>